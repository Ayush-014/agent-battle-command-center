# Agent Battle Command Center

A strategy-game inspired UI for managing AI agents, built on a custom backend that owns orchestration logic with CrewAI as the execution engine.

**POC Scope:** 2 agent types (Coder, QA), 10 tasks, best-in-class strategy game UI

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         MONOREPO (pnpm)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ packages/ui  │  │packages/api  │  │  packages/agents     │  │
│  │              │  │              │  │                      │  │
│  │ Vite + React │  │ Express +    │  │  Python + FastAPI    │  │
│  │ Tailwind     │  │ TypeScript   │  │  CrewAI executor     │  │
│  │ Socket.io    │  │ Prisma       │  │                      │  │
│  └──────┬───────┘  └──────┬───────┘  └──────────┬───────────┘  │
│         │                 │                      │              │
│         │    HTTP/WS      │      HTTP (internal) │              │
│         └────────────────►│◄─────────────────────┘              │
│                           │                                     │
│                           ▼                                     │
│                    ┌──────────────┐                             │
│                    │  PostgreSQL  │                             │
│                    └──────────────┘                             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ packages/shared - TypeScript types, constants            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  docker-compose.yml: postgres, api, agents, ui, ollama          │
└─────────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
agent-battle-command-center/
├── packages/
│   ├── ui/                 # Vite + React + Tailwind
│   │   ├── src/
│   │   │   ├── components/
│   │   │   │   ├── layout/
│   │   │   │   │   ├── CommandCenter.tsx
│   │   │   │   │   ├── TopBar.tsx
│   │   │   │   │   └── Sidebar.tsx
│   │   │   │   ├── minimap/
│   │   │   │   │   └── Minimap.tsx
│   │   │   │   ├── main-view/
│   │   │   │   │   ├── TaskQueue.tsx
│   │   │   │   │   ├── ActiveMissions.tsx
│   │   │   │   │   ├── TaskDetail.tsx
│   │   │   │   │   └── CreateTaskModal.tsx
│   │   │   │   ├── resources/
│   │   │   │   │   ├── ResourceBar.tsx
│   │   │   │   │   └── AlertPanel.tsx
│   │   │   │   └── shared/
│   │   │   │       ├── TaskCard.tsx
│   │   │   │       ├── AgentCard.tsx
│   │   │   │       └── StatusBadge.tsx
│   │   │   ├── hooks/
│   │   │   │   ├── useSocket.ts
│   │   │   │   ├── useTasks.ts
│   │   │   │   └── useAgents.ts
│   │   │   ├── api/
│   │   │   │   └── client.ts
│   │   │   ├── store/
│   │   │   │   └── uiState.ts
│   │   │   └── styles/
│   │   │       └── index.css
│   │   ├── package.json
│   │   ├── vite.config.ts
│   │   ├── tailwind.config.js
│   │   └── Dockerfile
│   │
│   ├── api/                # Node.js + Express + TypeScript
│   │   ├── src/
│   │   │   ├── index.ts
│   │   │   ├── config.ts
│   │   │   ├── routes/
│   │   │   │   ├── tasks.ts
│   │   │   │   ├── agents.ts
│   │   │   │   ├── queue.ts
│   │   │   │   ├── execute.ts
│   │   │   │   └── metrics.ts
│   │   │   ├── services/
│   │   │   │   ├── taskQueue.ts
│   │   │   │   ├── agentManager.ts
│   │   │   │   ├── fileLock.ts
│   │   │   │   ├── executor.ts
│   │   │   │   └── humanEscalation.ts
│   │   │   ├── websocket/
│   │   │   │   └── handler.ts
│   │   │   ├── db/
│   │   │   │   └── client.ts
│   │   │   └── types/
│   │   │       └── index.ts
│   │   ├── prisma/
│   │   │   ├── schema.prisma
│   │   │   └── seed.ts
│   │   ├── package.json
│   │   ├── tsconfig.json
│   │   └── Dockerfile
│   │
│   ├── agents/             # Python + FastAPI + CrewAI
│   │   ├── src/
│   │   │   ├── main.py
│   │   │   ├── config.py
│   │   │   ├── agents/
│   │   │   │   ├── base.py
│   │   │   │   ├── coder.py
│   │   │   │   └── qa.py
│   │   │   ├── tools/
│   │   │   │   ├── file_ops.py
│   │   │   │   ├── shell.py
│   │   │   │   └── search.py
│   │   │   └── models/
│   │   │       ├── claude.py
│   │   │       └── ollama.py
│   │   ├── requirements.txt
│   │   ├── pyproject.toml
│   │   └── Dockerfile
│   │
│   └── shared/             # Shared TypeScript types
│       ├── src/
│       │   └── index.ts
│       ├── package.json
│       └── tsconfig.json
│
├── workspace/              # Agent working directory
├── docker-compose.yml
├── pnpm-workspace.yaml
├── package.json
├── tsconfig.base.json
├── .env.example
├── .env
├── .gitignore
└── README.md
```

---

## Database Schema

### Tables

**agent_types** - Agent type definitions
- id, name, display_name, description, capabilities, icon, color

**agents** - Individual agent instances
- id, agent_type_id, name, status, current_task_id, config, stats

**tasks** - The task queue (bounty pool)
- id, title, description, task_type, required_agent, status, priority
- max_iterations, current_iteration, assigned_agent_id, assigned_at
- needs_human_at, human_timeout_minutes, escalated_to_agent_id
- result, error, api_credits_used, time_spent_ms, locked_files, parent_task_id

**task_executions** - Task execution history
- id, task_id, agent_id, iteration, status
- api_credits_used, duration_ms, input, output, error, logs

**file_locks** - Prevent file conflicts
- id, file_path, locked_by_agent, locked_by_task, locked_at, expires_at

**events** - Real-time UI updates
- id, event_type, payload, created_at

---

## API Endpoints

### Tasks
```
POST   /api/tasks              - Create task (add to pool)
GET    /api/tasks              - List tasks (with filters)
GET    /api/tasks/:id          - Get task details
PATCH  /api/tasks/:id          - Update task
DELETE /api/tasks/:id          - Cancel/delete task
POST   /api/tasks/:id/retry    - Return failed task to pool
POST   /api/tasks/:id/human    - Submit human input
POST   /api/tasks/:id/abort    - Abort task
```

### Agents
```
GET    /api/agents             - List all agents
GET    /api/agents/types       - Get agent types
GET    /api/agents/:id         - Get agent details + current task
PATCH  /api/agents/:id         - Update agent config
POST   /api/agents/:id/pause   - Pause agent (micromanager)
POST   /api/agents/:id/resume  - Resume agent
POST   /api/agents/:id/abort   - Abort current task
POST   /api/agents/:id/offline - Set agent offline
POST   /api/agents/:id/online  - Set agent online
GET    /api/agents/:id/stats   - Get agent stats
```

### Queue
```
GET    /api/queue              - Get queue state (pending tasks)
POST   /api/queue/assign       - Manually assign task
POST   /api/queue/auto-assign  - Auto-assign next task to agent
GET    /api/queue/locks        - Get file locks
DELETE /api/queue/locks/:path  - Release file lock
```

### Execute
```
POST   /api/execute            - Start task execution
POST   /api/execute/abort      - Abort execution
GET    /api/execute/health     - Check executor health
```

### Metrics
```
GET    /api/metrics/overview   - Dashboard stats
GET    /api/metrics/agents/:id - Per-agent analytics
GET    /api/metrics/timeline   - Time-series data
GET    /api/metrics/distribution - Task distribution
```

### WebSocket Events (Socket.io)
```
task_created        - New task added
task_updated        - Task status/data changed
task_deleted        - Task removed
agent_status_changed - Agent status update
alert               - System alert (stuck agent, conflict)
metrics_updated     - Metrics refresh
```

---

## Agent Types

### Coder Agent
- **Role:** Senior Software Developer
- **Goal:** Write clean, efficient, well-tested code
- **Tools:** file_read, file_write, file_edit, shell_run, code_search, find_file

### QA Agent
- **Role:** QA Engineer
- **Goal:** Ensure code quality through thorough testing
- **Tools:** file_read, file_write, shell_run, code_search, find_file

---

## UI Modes

### Overseer Mode
- Autonomous task queue management (Majesty-style)
- Tasks auto-assign to idle agents
- Minimal human intervention
- Real-time progress monitoring

### Micromanager Mode
- Step-by-step execution with human approval
- Manual agent control (pause/resume/abort)
- Task reassignment
- Detailed execution logging

---

## UI Layout

```
┌─────────────────────────────────────────────────────────────────┐
│ TOP BAR                                                         │
│ [API Credits: ████░░ 2,450] [Time: 4h 23m] [Iterations: 47]    │
│                                    [OVERSEER ◉] [○ DASHBOARD]   │
└─────────────────────────────────────────────────────────────────┘
┌────────────┬────────────────────────────────────────────────────┐
│            │                                                    │
│  MINIMAP   │              MAIN VIEW                             │
│            │                                                    │
│  ┌──────┐  │  ┌─────────────────────────────────────────────┐  │
│  │ ○  ○ │  │  │ TASK QUEUE (Bounty Board)                   │  │
│  │   ●  │  │  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐            │  │
│  │ ○    │  │  │ │Task1│ │Task2│ │Task3│ │Task4│ ...        │  │
│  └──────┘  │  │ └─────┘ └─────┘ └─────┘ └─────┘            │  │
│            │  └─────────────────────────────────────────────┘  │
│  AGENTS    │                                                    │
│  ┌──────┐  │  ┌─────────────────────────────────────────────┐  │
│  │Coder1│  │  │ ACTIVE MISSIONS                             │  │
│  │ ████ │  │  │                                             │  │
│  │ busy │  │  │  Coder-01 ──────────► [Task #7]            │  │
│  ├──────┤  │  │  ████████░░░░░░░░░  45%                    │  │
│  │Coder2│  │  │                                             │  │
│  │ idle │  │  │  QA-Alpha ──────────► [Task #5]            │  │
│  ├──────┤  │  │  ████████████████░░  89%                   │  │
│  │QA-01 │  │  │                                             │  │
│  │ busy │  │  └─────────────────────────────────────────────┘  │
│  └──────┘  │                                                    │
│            │  ┌─────────────────────────────────────────────┐  │
│  ALERTS    │  │ ⚠️ ALERTS                                    │  │
│  ┌──────┐  │  │ • Coder-02 waiting for human input (12m)   │  │
│  │⚠️ 2  │  │  │ • File conflict: src/api.ts                │  │
│  └──────┘  │  └─────────────────────────────────────────────┘  │
│            │                                                    │
└────────────┴────────────────────────────────────────────────────┘
```

---

## Quick Start

### Prerequisites
- Node.js 18+
- pnpm 8+
- Docker & Docker Compose
- Python 3.11+ (for local agents development)

### Setup

1. **Install dependencies:**
```bash
cd C:\Users\david\dev\agent-battle-command-center
pnpm install
```

2. **Configure environment:**
```bash
cp .env.example .env
# Edit .env with your ANTHROPIC_API_KEY
```

3. **Start infrastructure:**
```bash
pnpm docker:up
```

4. **Run database migrations:**
```bash
pnpm db:generate
pnpm db:migrate
pnpm db:seed
```

5. **Start development servers:**
```bash
pnpm dev
```

6. **Access the UI:**
- UI: http://localhost:5173
- API: http://localhost:3001
- Agents: http://localhost:8000

---

## Scripts

### Root
```bash
pnpm dev          # Start API and UI
pnpm dev:api      # Start API only
pnpm dev:ui       # Start UI only
pnpm build        # Build all packages
pnpm lint         # Lint all packages
pnpm docker:up    # Start Docker services
pnpm docker:down  # Stop Docker services
pnpm docker:logs  # View Docker logs
```

### Database
```bash
pnpm db:generate  # Generate Prisma client
pnpm db:push      # Push schema to database
pnpm db:migrate   # Run migrations
pnpm db:studio    # Open Prisma Studio
pnpm db:seed      # Seed database
```

---

## Environment Variables

```bash
# Database
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/abcc?schema=public"

# API Server
API_PORT=3001
API_HOST=0.0.0.0

# Agents Service
AGENTS_URL=http://localhost:8000
AGENTS_PORT=8000

# UI
VITE_API_URL=http://localhost:3001
VITE_WS_URL=ws://localhost:3001

# LLM Configuration
ANTHROPIC_API_KEY=your_anthropic_api_key_here
OLLAMA_URL=http://localhost:11434

# Default model settings
DEFAULT_MODEL=claude-sonnet-4-20250514
FALLBACK_TO_OLLAMA=true
OLLAMA_MODEL=llama3.1:8b

# Human escalation
HUMAN_TIMEOUT_MINUTES=30
```

---

## Task Queue Logic (Majesty Model)

The task assignment follows a "bounty pool" model inspired by the game Majesty:

1. Tasks are added to a pending pool
2. Idle agents automatically pick tasks based on:
   - Status = 'pending'
   - required_agent matches agent type OR is null
   - No file lock conflicts
   - Highest priority first
   - Oldest first (FIFO within priority)
3. File locks are acquired when task is assigned
4. On completion, locks are released and agent picks next task
5. On failure, task retries or escalates to human

---

## Human Escalation Flow

1. Agent marks task as `needs_human`
2. Timer starts (default 30 minutes)
3. Alert shown in UI
4. Human can:
   - Approve (resume execution)
   - Modify (provide new input)
   - Reject (abort task)
5. If timeout expires, task escalates to another agent

---

## Type Definitions

```typescript
// Agent Types
type AgentType = 'coder' | 'qa';
type AgentStatus = 'idle' | 'busy' | 'stuck' | 'offline';

// Task Types
type TaskType = 'code' | 'test' | 'review' | 'debug' | 'refactor';
type TaskStatus = 'pending' | 'assigned' | 'in_progress' |
                  'needs_human' | 'completed' | 'failed' | 'aborted';
type TaskPriority = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10;

// UI Mode
type UIMode = 'overseer' | 'dashboard';
```

---

## Color Scheme

```
Background:     #0a0e14 (command-bg)
Panel:          #141a22 (command-panel)
Border:         #1e2836 (command-border)
Accent:         #2d3b4f (command-accent)

HUD Green:      #00ff88 (hud-green)
HUD Blue:       #00aaff (hud-blue)
HUD Amber:      #ffaa00 (hud-amber)
HUD Red:        #ff4444 (hud-red)
HUD Purple:     #aa55ff (hud-purple)

Coder Agent:    #3B82F6 (agent-coder)
QA Agent:       #10B981 (agent-qa)

Status Pending: #6B7280
Status Active:  #3B82F6
Status Stuck:   #F59E0B
Status Done:    #10B981
Status Failed:  #EF4444
```

---

## Finalized Decisions

- **ORM**: Prisma (great DX, auto-generated types)
- **WebSocket**: Socket.io (auto-reconnect, rooms, battle-tested)
- **State Management**: Zustand (minimal, performant)
- **Styling**: Tailwind CSS + custom strategy game theme
- **LLM**: Claude (primary) + Ollama (fallback)
- **Agent Framework**: CrewAI
