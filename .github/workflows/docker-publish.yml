name: Publish Docker Images

on:
  release:
    types: [published]

env:
  REGISTRY: docker.io
  API_IMAGE: dushidush/api
  AGENTS_IMAGE: dushidush/agents
  UI_IMAGE: dushidush/ui

jobs:
  publish:
    name: Build & Push Images
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version from release tag
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          # Strip leading 'v' if present (v0.2.1 -> 0.2.1)
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build & push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.API_IMAGE }}:latest
            ${{ env.API_IMAGE }}:${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,scope=api,mode=max

      - name: Build & push Agents image
        uses: docker/build-push-action@v5
        with:
          context: ./packages/agents
          file: packages/agents/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.AGENTS_IMAGE }}:latest
            ${{ env.AGENTS_IMAGE }}:${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=agents
          cache-to: type=gha,scope=agents,mode=max

      - name: Build & push UI image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/ui/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.UI_IMAGE }}:latest
            ${{ env.UI_IMAGE }}:${{ steps.version.outputs.version }}
          build-args: |
            VITE_API_URL=http://localhost:3001
            VITE_WS_URL=ws://localhost:3001
          cache-from: type=gha,scope=ui
          cache-to: type=gha,scope=ui,mode=max

      - name: Summary
        run: |
          echo "## Published Docker Images" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | Tags |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| \`${{ env.API_IMAGE }}\` | \`latest\`, \`${{ steps.version.outputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| \`${{ env.AGENTS_IMAGE }}\` | \`latest\`, \`${{ steps.version.outputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| \`${{ env.UI_IMAGE }}\` | \`latest\`, \`${{ steps.version.outputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Quick test" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`bash" >> "$GITHUB_STEP_SUMMARY"
          echo "docker compose -f docker-compose.hub.yml up" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
